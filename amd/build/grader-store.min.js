'use strict';var _extends=Object.assign||function(a){for(var c,b=1;b<arguments.length;b++)for(var d in c=arguments[b],c)Object.prototype.hasOwnProperty.call(c,d)&&(a[d]=c[d]);return a};function _defineProperty(a,b,c){return b in a?Object.defineProperty(a,b,{value:c,enumerable:!0,configurable:!0,writable:!0}):a[b]=c,a}function _toConsumableArray(a){if(Array.isArray(a)){for(var b=0,c=Array(a.length);b<a.length;b++)c[b]=a[b];return c}return Array.from(a)}define(['local_customgrader/grader-utils','local_customgrader/grader-enums','local_customgrader/grader-service','local_customgrader/vendor-vue','local_customgrader/vendor-lodash'],function(a,b,c,d,e){var n,o,f=function(p,q){switch(q.name){case b.sortStudentMethods.FIRST_NAME:return e.orderBy(p,['firstname'],q.order);case b.sortStudentMethods.LAST_NAME:return e.orderBy(p,['lastname'],q.order);}},g={ADD_GRADE:'addGrade',DELETE_CATEGORY:'deleteCategory',ADD_ITEM:'addItem',ADD_CATEGORY:'addCategory',ADD_GRADE_TO_STUDENT:'addGradeToStudent',SET_STATE:'setAllState',SET_GRADE:'setGrade',SET_GRADES:'setGrades',SET_CATEGORY:'setCategory',SET_STUDENT_SORT_METHOD:'setStudentSortMethod',SET_SELECTED_CATEGORY_ID:'setSelectedCategoryId',SET_LEVELS:'setLevels',SET_ITEM:'setItem',DELETE_ITEM:'deleteItem',DELETE_GRADE:'deleteItemGrades'},h={FETCH_STATE:'fetchAllState',FILL_GRADES:'fillGrades',FILL_GRADES_FOR_NEW_ITEM:'fillGradesForNewItem',UPDATE_GRADE:'updateGrade',DELETE_ITEM:'deleteItem',DELETE_CATEGORY_CHILDS:'deleteCategoryChilds',UPDATE_CATEGORY:'setCategory',ADD_ITEM:'addItem',ADD_PARTIAL_EXAM:'addPartialExam',DELETE_CATEGORY:'deleteCategory',ADD_CATEGORY:'addCategory',UPDATE_ITEM:'setItem',DELETE_ITEM_GRADES:'deleteItemGrades'},j={state:{decimalPlaces:2,additionalColumnsAtFirst:[{text:'C\xF3digo estudiante'},{text:'',hide:!0}],additionalColumnsAtEnd:[{text:'Nota final'}],sortStudentsMethodType:{name:b.sortStudentMethods.LAST_NAME,order:b.sortDirection.ASC},students:{},selectedCategoryId:null,items:{},categories:[],grades:{},levels:[],course:{fullname:'Nombre completo de el curso'}},mutations:(n={},_defineProperty(n,g.DELETE_ITEM,function(p,q){d.delete(p.items,q)}),_defineProperty(n,g.DELETE_CATEGORY,function(p,q){var r=p.categories.map(function(s){return s.id}).indexOf(q);d.delete(p.categories,r)}),_defineProperty(n,g.SET_STUDENT_SORT_METHOD,function(p,q){p.sortStudentsMethodType=q}),_defineProperty(n,g.DELETE_GRADE,function(p,q){Object.keys(p.students).forEach(function(r){var s=p.students[r];d.set(p.students[r],'gradeIds',s.gradeIds.filter(function(t){return t!==q}))}),d.delete(p.grades,q)}),_defineProperty(n,g.ADD_ITEM,function(p,q){d.set(p.items,q.id,q)}),_defineProperty(n,g.ADD_CATEGORY,function(p,q){p.categories.push(q)}),_defineProperty(n,g.ADD_GRADE,function(p,q){q.id=a.ID();var r=p.students[q.userid],s=r.gradeIds?r.gradeIds:[];d.set(p.grades,q.id,q),d.set(p.students[r.id],'gradeIds',[].concat(_toConsumableArray(s),[q.id]))}),_defineProperty(n,g.ADD_GRADE_TO_STUDENT,function(p,q){var r=q.grade,s=q.studentId,t=p.students[s],u=t.gradeIds?t.gradeIds:[];d.set(p.students[s],'gradeIds',[].concat(_toConsumableArray(u),[r.id]))}),_defineProperty(n,g.SET_ITEM,function(p,q){d.set(p.items,q.id,q)}),_defineProperty(n,g.SET_LEVELS,function(p,q){p.levels=q}),_defineProperty(n,g.SET_CATEGORY,function(p,q){var r=p.categories.map(function(s){return s.id}).indexOf(q.id);d.set(p.categories,r,q)}),_defineProperty(n,g.SET_GRADES,function(p,q){q.forEach(function(r){if(r.finalgrade=a.removeInsignificantTrailZeros(r.finalgrade),!p.grades[r.id]){var s=Object.values(p.grades).find(function(v){return v.itemid===r.itemid&&v.userid===r.userid});p.grades[r.id]=r;var t=p.students[s.userid].gradeIds,u=[].concat(_toConsumableArray(t.filter(function(v){return v!==s.id})),[r.id]);p.students[r.userid]=_extends({},p.students[r.userid],{gradeIds:u}),d.delete(p.grades,s.id)}d.set(p.grades,r.id,r)})}),_defineProperty(n,g.SET_GRADE,function(p,q){var r=q.old,s=q.new;if(s.finalgrade=a.removeInsignificantTrailZeros(s.finalgrade),p.grades[s.id]=s,r&&r.id!==s.id){var t=p.students[r.userid].gradeIds,u=[].concat(_toConsumableArray(t.filter(function(v){return v!==r.id})),[s.id]);p.students[r.userid]=_extends({},p.students[r.userid],{gradeIds:u}),d.delete(p.grades,r.id)}}),_defineProperty(n,g.SET_SELECTED_CATEGORY_ID,function(p,q){p.selectedCategoryId=q}),_defineProperty(n,g.SET_STATE,function(p,q){p.levels=q.levels;var r={};q.students.forEach(function(u){r[u.id]=u}),p.students=r;var s={};q.items.forEach(function(u){s[u.id]=u}),p.items=s,p.categories=q.categories;var t={};q.grades.forEach(function(u){t[u.id]=_extends({},u,{finalgrade:a.removeInsignificantTrailZeros(u.finalgrade)})}),p.grades=t,p.course=q.course}),n),actions:(o={},_defineProperty(o,h.DELETE_ITEM,function(p,q){var r=p.commit,s=p.dispatch,t=p.state;c.delete_item(q).then(function(u){r(g.SET_LEVELS,u.levels),r(g.DELETE_ITEM,q),s(h.DELETE_ITEM_GRADES,q)})}),_defineProperty(o,h.ADD_ITEM,function(p,q){var r=p.commit,s=p.dispatch;c.add_item(q).then(function(t){r(g.ADD_ITEM,t.item),r(g.SET_LEVELS,t.levels),s(h.FILL_GRADES_FOR_NEW_ITEM,t.item)})}),_defineProperty(o,h.DELETE_ITEM_GRADES,function(p,q){var r=p.commit,s=p.state,t=Object.keys(s.grades),u=[];t.forEach(function(v){s.grades[v].itemid===q&&u.push(v)}),u.forEach(function(v){r(g.DELETE_GRADE,v)})}),_defineProperty(o,h.ADD_PARTIAL_EXAM,function(p,q){var r=p.commit,s=p.getters;c.add_partial_exam(q).then(function(t){r(g.SET_LEVELS,t.levels),r(g.ADD_CATEGORY,t.category),r(g.ADD_ITEM,t.partial_item),r(g.ADD_ITEM,t.optional_item)})}),_defineProperty(o,h.DELETE_CATEGORY_CHILDS,function(p,q){var r=p.commit,s=p.getters,t=p.dispatch,u=s.categoryChildItems(q),v=s.categoryChildCategories(q);u.forEach(function(w){r(g.DELETE_ITEM,w.id),t(h.DELETE_ITEM_GRADES,w.id)}),v.forEach(function(w){r(g.DELETE_CATEGORY,w.id)})}),_defineProperty(o,h.DELETE_CATEGORY,function(p,q){var r=p.commit,s=p.getters,t=p.dispatch;c.delete_category(q).then(function(u){r(g.SET_LEVELS,u.levels),t(h.DELETE_CATEGORY_CHILDS,q),r(g.DELETE_CATEGORY,q)})}),_defineProperty(o,h.FILL_GRADES_FOR_NEW_ITEM,function(p,q){var r=p.commit,s=p.state,t=p.getters,u=Object.keys(s.students);u.forEach(function(v){var w={userid:v,itemid:q.id,finalgrade:null,rawgrademin:q.grademin,rawgrademax:q.grademax};r(g.ADD_GRADE,w)})}),_defineProperty(o,h.FILL_GRADES,function(p){var q=p.commit,r=p.state,s=p.getters,t=Object.keys(r.students),u=Object.values(r.grades);t.forEach(function(v){var w=!0,x=!1,y=void 0;try{for(var B,z=function _loop(){C=B.value;var D=r.items[C],E=u.find(function(G){return G.userid===v&&G.itemid===D.id});if(!E){var F={userid:v,itemid:D.id,finalgrade:null,rawgrademin:D.grademin,rawgrademax:D.grademax};q(g.ADD_GRADE,F)}else q(g.ADD_GRADE_TO_STUDENT,{studentId:v,grade:E})},A=s.itemOrderIds[Symbol.iterator]();!(w=(B=A.next()).done);w=!0){var C;z()}}catch(D){x=!0,y=D}finally{try{!w&&A.return&&A.return()}finally{if(x)throw y}}})}),_defineProperty(o,h.UPDATE_GRADE,function(p,q){var r=p.commit,s=p.state;c.update_grade(q,s.course.id).then(function(t){r(g.SET_GRADE,{old:q,new:t.grade}),r(g.SET_GRADES,t.other_grades)})}),_defineProperty(o,h.UPDATE_CATEGORY,function(p,q){var r=p.dispatch,s=p.commit;c.update_category(q).then(function(t){var u=t.category,v=t.levels;s(g.SET_CATEGORY,u),s(g.SET_LEVELS,v)})}),_defineProperty(o,h.ADD_CATEGORY,function(p,q){var r=p.commit,s=p.state,t=p.dispatch;c.add_category(q.category,q.weight).then(function(u){var v=u.category,w=u.category_item,x=u.levels;r(g.ADD_ITEM,w),r(g.ADD_CATEGORY,v),r(g.SET_LEVELS,x),t(h.FILL_GRADES_FOR_NEW_ITEM,w)})}),_defineProperty(o,h.UPDATE_ITEM,function(p,q){var r=p.dispatch,s=p.commit;c.update_item(q).then(function(t){var u=t.item,v=t.levels;s(g.SET_ITEM,u),s(g.SET_LEVELS,v)})}),_defineProperty(o,h.FETCH_STATE,function(p){var q=p.dispatch,r=p.commit;c.get_grader_data(a.getCourseId()).then(function(s){r(g.SET_STATE,s),q(h.FILL_GRADES)})}),o),getters:{courseLevel:function courseLevel(p){return p.levels[0]?p.levels[0][0]:[]},selectedCategory:function selectedCategory(p,q){return q.categoryById(p.selectedCategoryId)},itemLevel:function itemLevel(p){return p.levels[p.levels.length-1]},categoryLevels:function categoryLevels(p){var q=p.levels.slice(1,p.levels.length-1);return q?q:[]},itemsCount:function itemsCount(p){return Object.keys(p.items).length},categoryById:function categoryById(p){return function(q){return p.categories.find(function(r){return r.id===q})}},studentById:function studentById(p){return function(q){return p.students[q]}},studentSetSorted:function studentSetSorted(p,q){return f(q.studentSet,p.sortStudentsMethodType)},studentSet:function studentSet(p){return Object.values(p.students)},studentsCount:function studentsCount(p){return Object.keys(p.students).length},itemSet:function itemSet(p){return Object.values(p.items)},itemOrderIds:function itemOrderIds(p,q){var r=q.itemLevel;return r?r.map(function(s){return s.object.id}):Object.keys(p.items)},categoryChildItems:function categoryChildItems(p,q){return function(r){var s=q.itemSet.filter(function(t){return t.categoryid===r||t.iteminstance===r});return Array.isArray(s)?s:[]}},categoryChildCategories:function categoryChildCategories(p){return function(q){var r=p.categories.filter(function(s){return s.parent===q});return r?r:[]}},categoryChildSize:function categoryChildSize(p,q){return function(r){var s=q.categoryChildItems(r),t=q.categoryChildCategories(r);return s.length+t.length}},categoryDepth:function categoryDepth(p){if(0>=p.categories.length)return 0;var q=p.categories.map(function(r){return r.depth});return Math.max.apply(Math,q)},getCategoriesByDepth:function getCategoriesByDepth(p){return function(q){return p.categories.find(function(r){return r.depth===q})}}}};return{store:j,mutations:g,actions:h}});