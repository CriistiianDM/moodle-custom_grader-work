define(["jquery","block_ases/bootstrap","block_ases/sweetalert","block_ases/jqueryui"],function(e,t,a,r){return{init:function(){var t,a=e('<div class ="mini-menu"><i class="fa fa-plus"></i></div>'),r=e('<div class ="mini-menu"><i class="fa fa-edit" title="Editar Ítem"></i><i class="fa fa-trash"></i></div>');function o(t,a,r){e.ajax({type:"POST",data:{course:t,element:a,type_e:r,type:"loadParentCat"},url:"../managers/grade_categories/grader_processing.php",success:function(t){e("#padre").html(t.html)},dataType:"json",cache:"false",error:function(e){console.log(e)}})}function n(t,a,r){e.ajax({type:"POST",data:{type_ajax:"deleteElement",id:t,courseid:a,type:r},url:"../managers/grade_categories/grader_processing.php",success:function(e){swal({title:"Listo",text:e.msg,type:"success",showCancelButton:!1,showConfirmButton:!1,timer:1200}),location.reload(),l(a)},dataType:"json",cache:"false",error:function(e){console.log(e)}})}function i(){for(var e=window.location.search.split("&"),t=0;t<e.length;t++){var a=e[t].split("=");if("?id_course"==a[0]||"id_course"==a[0])var r=a[1]}return r}function l(t){e.ajax({type:"POST",data:{course:t,type:"loadCat"},url:"../managers/grade_categories/grader_processing.php",success:function(t){e("#mymodalbody").html(t)},dataType:"text",cache:"false",error:function(e){console.log(e)}})}a.appendTo(e("th.category:not(.catlevel1)")),r.appendTo(e("th.item")),e(".mini-menu").attr("iditem",function(){return e(this).parent().attr("data-itemid")}),e(".mini-menu").children().attr("iditem",function(){return e(this).parent().attr("iditem")}),e(document).on("click","#wizard_button",function(){e("#modalCategories").modal({backdrop:!1}),e(".fondo").show(),id=i(),l(id)}),e(document).on("click",".fa-plus",function(){e("#modalCategories").modal({backdrop:!1}),e(".fondo").show(),id=i(),l(id)}),e(document).on("click",".fa-edit",function(){id=i(),l(id);var a="#"+e(this).attr("iditem");setTimeout(function(){!function(a){console.log(a);var r=a.attr("title");e("#titulo").text(r);var n=!1;e("#nombre_editar").show(),e("#label_nombre").show(),e("#alta").show(),e("#div_padres").show(),a.hasClass("curso")&&(n=!0,e("#alta").hide(),console.log("CURSO"),e("#nombre_editar").hide(),e("#label_nombre").hide(),e("#div_padres").hide());var l=i(),s=a.attr("id");if(e("#save_edit").attr("name",s),"Editar Categoría"===r){e("#type_cal").show();var c=a.parent().parent().attr("id");e("#otro").hide(),10!=c&&0!=c&&6!=c&&(c=99,e("#otro").show()),e("#calific").prop("value",c);var d="cat",p=a.parent().parent().text();if(-1==p.search("-")){nom_text=p.split("("),p=nom_text[0],m=nom_text[1],n||e("#peso").show(),m=(m=(m=(m=m.replace("(","")).replace(")","")).replace(" ","")).replace("%",""),t=m,e("#peso_editar").val(m);var u=a.attr("data-maxweight");e(".maxweight-edit").attr("id",u)}else p=p.split("-")[0],e("#peso").hide()}else{e("#type_cal").hide();var m=a.parent().parent().prev().text();if("-"==m)e("#peso").hide(),e("#peso_editar").val(m);else{e("#peso").show(),m=(m=(m=(m=m.replace("(","")).replace(")","")).replace(" ","")).replace("%",""),t=m,e("#peso_editar").val(m);var u=a.parent().attr("id");e(".maxweight-edit").attr("id",u)}var d="it",p=a.parent().parent().prev().prev().attr("title");"Enlazar a la actividad Tarea"==p&&(e("#nombre_editar").hide(),e("#label_nombre").hide())}e("#nombre_editar").val(p),o(l,s,d),e("#edit").modal({backdrop:!1})}(e(a))},300)}),e(document).on("click",".fa-trash",function(){id=i(),l(id);var t="#"+e(this).attr("iditem");setTimeout(function(){$element=e(t).parent().children().last(),console.log($element),function(e){var t=e.parent().parent().parent().attr("id").split("_"),a=i(),r=t[1],o=t[0];if("cat"===o)var l="esta categoría";else var l="este item";swal({title:"Esta seguro que desea eliminar "+l+"?",text:"Tenga en cuenta que NO SE PODRAN RECUPERAR ninguna de la notas que haya registrado en este elemento una vez borrado!",type:"warning",showCancelButton:!0,confirmButtonClass:"btn-danger",confirmButtonText:"Aceptar, Borrar "+l,cancelButtonText:"Cancelar",closeOnConfirm:!1,closeOnCancel:!1},function(e){e?n(r,a,o):swal({title:"Cancelado",type:"error",showCancelButton:!1,showConfirmButton:!1,timer:1200})})}(e(t))},300)}),e(document).on("click",".mymodal-close",function(){location.reload(),e(".fondo").hide()}),e(document).on("click",".edit",function(){console.log(e(this));var a=e(this).attr("title");e("#titulo").text(a);var r=!1;e("#nombre_editar").show(),e("#label_nombre").show(),e("#alta").show(),e("#div_padres").show(),e(this).hasClass("curso")&&(r=!0,e("#alta").hide(),console.log("CURSO"),e("#nombre_editar").hide(),e("#label_nombre").hide(),e("#div_padres").hide());var n=i(),l=e(this).attr("id");if(e("#save_edit").attr("name",l),"Editar Categoría"===a){e("#type_cal").show();var s=e(this).parent().parent().attr("id");e("#otro").hide(),10!=s&&0!=s&&6!=s&&(s=99,e("#otro").show()),e("#calific").prop("value",s);var c="cat";if(-1==(u=e(this).parent().parent().text()).search("-")){nom_text=u.split("("),u=nom_text[0],p=nom_text[1],r||e("#peso").show(),p=(p=(p=(p=p.replace("(","")).replace(")","")).replace(" ","")).replace("%",""),t=p,e("#peso_editar").val(p);var d=e(this).attr("data-maxweight");e(".maxweight-edit").attr("id",d)}else u=u.split("-")[0],e("#peso").hide()}else{e("#type_cal").hide();var p=e(this).parent().parent().prev().text();if("-"==p)e("#peso").hide(),e("#peso_editar").val(p);else{e("#peso").show(),p=(p=(p=(p=p.replace("(","")).replace(")","")).replace(" ","")).replace("%",""),t=p,e("#peso_editar").val(p);d=e(this).parent().attr("id");e(".maxweight-edit").attr("id",d)}var u;c="it";"Enlazar a la actividad Tarea"==(u=e(this).parent().parent().prev().prev().attr("title"))&&(e("#nombre_editar").hide(),e("#label_nombre").hide())}e("#nombre_editar").val(u),o(n,l,c),e("#edit").modal({backdrop:!1})}),e(document).on("click","#save_edit",function(){var a=e(this).attr("name"),r=e("#nombre_editar").val(),o=e("#peso_editar").val(),n=parseFloat(e(".maxweight-edit").attr("id"))+parseFloat(t),s=e("#calific").val(),c=e("#padre").val();if("-"==o&&(o=0),"99"!=s)if(console.log("nombre: "+r+"\n peso:"+o+"\n MAXpeso:"+n+"\n new_calif: "+s),o>n)swal({title:"Peso no valido.",text:"El peso ingresado supera el peso máximo posible de la categoria padre que es: "+n+"% \n Para crear un nuevo elemento primero configure los pesos de los demas.",html:!0,type:"warning",confirmButtonColor:"#d51b23"});else if(""!=r){"Ítem"==e("#titulo").text().split(" ")[1]?(type_e="it",s=!1):type_e="cat";var d=i();e.ajax({type:"POST",data:{course:d,element:a,type_e:type_e,newNombre:r,newPeso:o,newCalific:s,type:"editElement",parent:c},url:"../managers/grade_categories/grader_processing.php",success:function(t){t.error?swal("Error",t.error,"error"):(swal({title:"Listo",text:t.msg,type:"success",showCancelButton:!1,showConfirmButton:!1,timer:1300}),e("#edit").modal("hide"),l(d),console.log(t),location.reload())},dataType:"json",cache:"false",error:function(e){console.log("AJAXerror"),console.log(e)}})}else swal({title:"Ingrese el nuevo nombre del elemento",html:!0,type:"warning",confirmButtonColor:"#d51b23"});else swal({title:"Tipo de Calificacion no valida.",text:"No es posible editar una categoria con un tipo de calificacion diferente a Promedio Simple, Promedio Ponderado, o Calificacion mas alta.\n Por favor seleccione uno de estos tipos de calificacion",html:!0,type:"warning",confirmButtonColor:"#d51b23"})}),e(document).on("click",".delete",function(){var t=e(this).parent().parent().parent().attr("id").split("_"),a=i(),r=t[1],o=t[0];if("cat"===o)var l="esta categoría";else l="este item";swal({title:"Esta seguro que desea eliminar "+l+"?",text:"Tenga en cuenta que NO SE PODRAN RECUPERAR ninguna de la notas que haya registrado en este elemento una vez borrado!",type:"warning",showCancelButton:!0,confirmButtonClass:"btn-danger",confirmButtonText:"Aceptar, Borrar "+l,cancelButtonText:"Cancelar",closeOnConfirm:!1,closeOnCancel:!1},function(e){e?n(r,a,o):swal({title:"Cancelado",type:"error",showCancelButton:!1,showConfirmButton:!1,timer:1200})})}),e(document).on("click",".new",function(){if(e(this).parent().parent().children().next(".maxweight").attr("id")<=0)swal({title:"No se pueden crear mas categorías o ítems en la categoria seleccionada.",text:"\n\r El peso de los elementos dentro de ésta suma 100%.\n\r Para crear un nuevo elemento primero configure los pesos de los demas.",html:!0,type:"warning",confirmButtonColor:"#d51b23"});else{e(".new").prop("disabled",!0),e(".delete").prop("disabled",!0),e(".edit").prop("disabled",!0);var t=e("<div class = 'divForm'>");t.load("../templates/categories_form.html");var a=e(this).parent().parent();a.append('<hr style = "border-top: 1px solid #ddd">'),a.append(t),window.setTimeout(function(){10==a.attr("id")&&(e("#divPeso").show(),e("#inputValor").on("blur",function(){var t=e(this).val(),a=parseInt(e(this).parent().parent().parent().parent().children().next(".maxweight").attr("id"));(t<0||t>a)&&(swal({title:"El valor debe estar entre 0 y el peso máximo: "+a,text:"\n\rUsted ingresó: "+t,html:!0,type:"warning",confirmButtonColor:"#d51b23"}),e(this).val(""))}),e("#inputValor").on("keypress",function(e){return tecla=document.all?e.keyCode:e.which,8==tecla||46==tecla||(patron=/[0-9]/,tecla_final=String.fromCharCode(tecla),patron.test(tecla_final))})),e("#tipoItem").on("change",function(){1==e(this).prop("selectedIndex")?e("#divTipeC").show():e("#divTipeC").hide()}),e("#save").on("click",function(){var t=e(this).parent().parent().parent().parent().attr("id"),a=e(this).parent().parent().parent().parent().parent().attr("id");!function(t,a){var r=e("#tipoItem").val(),o=i();if("CATEGORÍA"==r){if(function(t){if(0==e("#tipoCalificacion").prop("selectedIndex"))return swal({title:"Seleccione el tipo de calificación de la categoría que desea crear",html:!0,type:"warning",confirmButtonColor:"#d51b23"}),!1;if(""==e.trim(e("#inputNombre").val()))return swal({title:"Ingrese el nombre de la categoría que desea crear",html:!0,type:"warning",confirmButtonColor:"#d51b23"}),!1;if(10==t){var a=e("#inputValor").val();if(""==a)return swal({title:"Ingrese un peso válido entre 0 y 100",html:!0,type:"warning",confirmButtonColor:"#d51b23"}),!1}return!0}(t)){var n=e.trim(e("#inputNombre").val()),s=e("#inputValor").val(),c=function(e){switch(e){case 1:return 0;case 2:return 10}}(e("#tipoCalificacion").prop("selectedIndex"));e.ajax({type:"POST",data:{course:o,parent:a,fullname:n,agregation:c,tipo:r,peso:s},url:"../managers/grade_categories/grader_processing.php",success:function(e){1==e?(swal({title:"Categoria añadida con exito",html:!0,type:"success",confirmButtonColor:"#d51b23"}),l(o)):0==e&&swal({title:"Error al añadir la categoria (server error)",html:!0,type:"error",confirmButtonColor:"#d51b23"})},cache:"false",error:function(e){swal({title:"Error al intentar añadir la categoria",html:!0,type:"error",confirmButtonColor:"#d51b23"})}})}}else if("ÍTEM"==r){if(function(t){if(""==e.trim(e("#inputNombre").val()))return swal({title:"Ingrese el nombre del ítem que desea crear",html:!0,type:"warning",confirmButtonColor:"#d51b23"}),!1;if(10==t){var a=e("#inputValor").val();if(""==a)return swal({title:"Ingrese un peso válido entre 0 y 100",html:!0,type:"warning",confirmButtonColor:"#d51b23"}),!1}return!0}(t)){var n=e.trim(e("#inputNombre").val()),s=e("#inputValor").val();e.ajax({type:"POST",data:{course:o,parent:a,fullname:n,tipo:r,peso:s},url:"../managers/grade_categories/grader_processing.php",success:function(e){1==e?(swal({title:"item añadido con exito",html:!0,type:"success",confirmButtonColor:"#d51b23"}),l(o)):0==e&&swal({title:"Error al añadir el item (server error)",html:!0,type:"error",confirmButtonColor:"#d51b23"})},cache:"false",error:function(e){swal({title:"Error al intentar añadir el item",html:!0,type:"error",confirmButtonColor:"#d51b23"})}})}}else if("PARCIAL"==r){if(function(t){if(""==e.trim(e("#inputNombre").val()))return swal({title:"Ingrese el nombre del parcial que desea crear",html:!0,type:"warning",confirmButtonColor:"#d51b23"}),!1;if(10==t){var a=e("#inputValor").val();if(""==a)return swal({title:"Ingrese un peso válido entre 0 y 100",html:!0,type:"warning",confirmButtonColor:"#d51b23"}),!1}return!0}(t)){var n=e.trim(e("#inputNombre").val()),s=e("#inputValor").val();e.ajax({type:"POST",data:{course:o,parent:a,fullname:n,agregation:6,tipo:r,peso:s},url:"../managers/grade_categories/grader_processing.php",success:function(e){1==e?(swal({title:"Categoria añadida con exito",html:!0,type:"success",confirmButtonColor:"#d51b23"}),l(o)):0==e&&swal({title:"Error al añadir la categoria (server error)",html:!0,type:"error",confirmButtonColor:"#d51b23"})},cache:"false",error:function(e){swal({title:"Error al intentar añadir la categoria",html:!0,type:"error",confirmButtonColor:"#d51b23"})}})}}else swal({title:"Seleccione el tipo de elemento que desea crear",html:!0,type:"warning",confirmButtonColor:"#d51b23"})}(t,a=a.split("_")[1])}),e("#cancel").on("click",function(){l(i())})},400)}})}}});